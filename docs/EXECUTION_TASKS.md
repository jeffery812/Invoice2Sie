# Invoice2SIE — 可执行实现任务拆解（工程师用）

> 目标：将 `docs/IMPLEMENTATION_PLAN.md` 拆解为工程可执行任务，覆盖 MVP 全流程。

---

## 1. 项目初始化与架构
1.1 初始化 Edge 扩展项目
- 新建 Manifest V3 结构（`manifest.json`、`background`、`content`、`popup`）
- 配置最小权限：`storage`、`downloads`、`scripting`（仅在需要读取 PDF 页面时启用）
- 加入基础构建/打包脚本（如 Vite/webpack）

1.2 代码目录结构
- `src/ui/`：UI 页面与组件
- `src/pdf/`：PDF 解析与文本层检测
- `src/ai/`：Gemini API 适配器
- `src/sie/`：SIE 规则与生成器
- `src/audit/`：审计日志与追踪
- `src/storage/`：本地存储与配置

1.3 基础配置与状态
- 定义全局配置对象（VAT 默认税率、科目映射、凭证系列等）
- 定义字段数据结构（必填/可选、置信度、trace）

---

## 2. PDF 输入与解析
2.1 本地上传流程
- UI 文件选择器
- 读取 PDF 二进制并传给解析模块

2.2 已打开 PDF 页面读取
- 在 PDF 页面注入脚本（或使用右键菜单触发）
- 获取 PDF 源或文本层（按可行性）

2.3 PDF.js 集成
- 渲染并读取文本层
- 输出：`rawText`、`pageBlocks`、`trace`

2.4 文本层检测
- 检测页面是否包含文本层
- 若无文本层：标记 `needsOcr=true`

2.5 OCR 兜底
- 若 `needsOcr=true`，提示用户
- MVP 默认转“全手动录入模式”

---

## 3. AI 字段抽取（结构化输出）
3.1 组装 Prompt 与输入
- 使用 `rawText`（可加入关键字段提示）
- 控制最大文本长度（超出提示用户）

3.2 Gemini API 调用
- 从 `chrome.storage.local` 读取 API Key
- 调用返回结构化字段 + 置信度

3.3 结果校验与清洗
- 空值过滤、金额格式统一
- 组织号 Luhn 校验失败 → 置信度降级
- 对低置信字段打标

3.4 AI 失败降级
- 超时/错误时允许手动录入继续流程

---

## 4. 人工确认 UI 与审计
4.1 界面布局
- 左侧 PDF 预览
- 右侧字段表单（分组/排序）

4.2 交互规则
- 低置信字段高亮
- 未确认不可导出

4.3 审计日志
- 记录字段修改（旧值/新值/时间）
- 可导出或附加在本地日志

---

## 5. SIE 规则引擎（本地生成）
5.1 SIE 基础结构
- 写入 `#GEN`、`#VER`、`#TRANS`
- 编码 UTF-8

5.2 分录生成逻辑
- 供应商发票：2440 贷方，费用+VAT 借方
- Credit Invoice 方向反转
- 保证 `SUM(#TRANS) = 0`

5.3 VAT 科目映射
- 25%→2641，12%→2642，6%→2645
- 允许用户自定义映射覆盖

5.4 舍入处理
- 差额写入 3740（Öresavrundning）
- 最终平衡校验

5.5 外币处理（非 MVP）
- 标记字段并阻止导出或提示用户

---

## 6. SIE 导出与校验
6.1 校验器
- 必填字段完整性
- 借贷平衡
- 税率与科目一致

6.2 导出
- 生成 `.sie` 文件
- 命名规则：`invoice_{invoice_number}_{yyyymmdd}.sie`

6.3 失败处理
- 校验失败提示具体原因
- 阻止导出

---

## 7. 设置与安全
7.1 设置页
- 输入 Gemini API Key
- 配置 VAT 税率、科目映射、凭证系列

7.2 存储
- `chrome.storage.local` 存储配置与密钥
- 提供清除缓存与日志入口

---

## 8. 测试与验收
8.1 单元测试
- SIE 生成器（平衡校验、舍入处理、VAT 映射）
- Luhn 校验

8.2 集成测试
- PDF→AI→确认→SIE 全流程
- OCR 缺失场景

8.3 验收数据
- 标准 VAT 25%
- 12%/6% VAT
- Credit Invoice
- 舍入分录

---

## 9. 交付与发布
9.1 内测包
- 生成 Edge 扩展打包版本
- 提供安装说明

9.2 反馈与迭代
- 收集导入失败案例
- 调整 VAT/科目映射规则
